<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ’­æ’­æ”¾è¯Šæ–­ï¼ˆiOS9ï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, "Helvetica Neue", sans-serif;
            background: #f5f5f5;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
        }
        .player-container {
            position: relative;
            padding-bottom: 56.25%;
            margin-bottom: 20px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .diagnose-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #url-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            background: #f8f8f8;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #1976D2;
        }
        .status {
            text-align: left;
            color: #333;
            font-size: 12px;
            margin-top: 10px;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .info { color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ç›´æ’­æ’­æ”¾è¯Šæ–­å·¥å…·</h1>
        <p>iOS9ä¸“ç”¨ï¼ˆè§£å†³"æ— æ”¯æŒæº"é—®é¢˜ï¼‰</p>
    </div>

    <div class="player-container">
        <video id="player" controls preload="none"></video>
    </div>

    <div class="diagnose-box">
        <input type="text" id="url-input" 
               value="http://play1-qk.nmtv.cn/live/1686561195713372.m3u8" 
               placeholder="è¾“å…¥m3u8åœ°å€" 
               readonly>
        <button onclick="startDiagnose()">å¼€å§‹è¯Šæ–­å¹¶æ’­æ”¾</button>
        <div class="status" id="status"></div>
    </div>

    <script>
        var player = document.getElementById('player');
        var statusEl = document.getElementById('status');
        var targetUrl = document.getElementById('url-input').value;

        function startDiagnose() {
            statusEl.className = 'status info';
            statusEl.textContent = 'ğŸ“‹ å¼€å§‹è¯Šæ–­...';
            
            // æ­¥éª¤1ï¼šéªŒè¯URLæ ¼å¼
            if (!validateUrl(targetUrl)) {
                statusEl.textContent += '\nâŒ æ­¥éª¤1/4ï¼šURLæ ¼å¼é”™è¯¯ï¼ˆéœ€ä»¥http://æˆ–https://å¼€å¤´ä¸”ä»¥.m3u8ç»“å°¾ï¼‰';
                return;
            }
            statusEl.textContent += '\nâœ… æ­¥éª¤1/4ï¼šURLæ ¼å¼éªŒè¯é€šè¿‡';

            // æ­¥éª¤2ï¼šæ£€æµ‹ç½‘ç»œè¿é€šæ€§
            testNetwork(function(isOnline) {
                if (!isOnline) {
                    statusEl.textContent += '\nâŒ æ­¥éª¤2/4ï¼šç½‘ç»œè¿æ¥å¤±è´¥ï¼ˆè®¾å¤‡æ— æ³•è®¿é—®äº’è”ç½‘ï¼‰';
                    return;
                }
                statusEl.textContent += '\nâœ… æ­¥éª¤2/4ï¼šç½‘ç»œè¿é€šæ€§æ­£å¸¸';

                // æ­¥éª¤3ï¼šæ£€æŸ¥æºæœåŠ¡å™¨å“åº”
                checkServerResponse(function(responseOk, statusCode) {
                    if (!responseOk) {
                        statusEl.textContent += `\nâŒ æ­¥éª¤3/4ï¼šæœåŠ¡å™¨è¿”å›å¼‚å¸¸çŠ¶æ€ç  ${statusCode}`;
                        return;
                    }
                    statusEl.textContent += '\nâœ… æ­¥éª¤3/4ï¼šæœåŠ¡å™¨å“åº”æ­£å¸¸';

                    // æ­¥éª¤4ï¼šè§£æHLSæµå†…å®¹
                    parseHlsManifest(function(valid, errorMsg) {
                        if (!valid) {
                            statusEl.textContent += `\nâŒ æ­¥éª¤4/4ï¼šHLSæµè§£æå¤±è´¥ - ${errorMsg}`;
                            return;
                        }
                        statusEl.textContent += '\nâœ… æ­¥éª¤4/4ï¼šHLSæµå†…å®¹æœ‰æ•ˆ';

                        // æœ€ç»ˆæ’­æ”¾
                        playStream(targetUrl);
                    });
                });
            });
        }

        function validateUrl(url) {
            return /^https?:\/\/.*\.m3u8$/i.test(url);
        }

        function testNetwork(callback) {
            var testXhr = new XMLHttpRequest();
            testXhr.open('HEAD', 'https://www.baidu.com', true); // æµ‹è¯•ç™¾åº¦éªŒè¯ç½‘ç»œ
            testXhr.timeout = 5000;
            testXhr.onload = function() { callback(true); };
            testXhr.onerror = function() { callback(false); };
            testXhr.ontimeout = function() { callback(false); };
            testXhr.send();
        }

        function checkServerResponse(callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('HEAD', targetUrl, true);
            xhr.timeout = 10000;
            xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (iPhone; CPU iPhone OS 9_3_5 like Mac OS X) AppleWebKit/601.1.46 (KHTML, like Gecko) Version/9.0 Mobile/13G36 Safari/601.1');
            
            xhr.onload = function() {
                callback(xhr.status >= 200 && xhr.status < 300, xhr.status);
            };
            xhr.onerror = function() { callback(false, 'ç½‘ç»œé”™è¯¯'); };
            xhr.ontimeout = function() { callback(false, 'è¶…æ—¶'); };
            xhr.send();
        }

        function parseHlsManifest(callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', targetUrl, true);
            xhr.timeout = 15000;
            xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (iPhone; CPU iPhone OS 9_3_5 like Mac OS X) AppleWebKit/601.1.46 (KHTML, like Gecko) Version/9.0 Mobile/13G36 Safari/601.1');
            
            xhr.onload = function() {
                if (xhr.status !== 200) {
                    callback(false, `æœåŠ¡å™¨è¿”å›çŠ¶æ€ç  ${xhr.status}`);
                    return;
                }

                var manifest = xhr.responseText;
                // æ£€æŸ¥æ˜¯å¦åŒ…å«#EXTM3Uå¤´
                if (!manifest.includes('#EXTM3U')) {
                    callback(false, 'ç¼ºå°‘HLSæ ‡å‡†å¤´#EXTM3U');
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰TSåˆ†ç‰‡ï¼ˆå…³é”®éªŒè¯ï¼‰
                if (!manifest.match(/\.ts\b/i)) {
                    callback(false, 'æœªæ‰¾åˆ°TSåˆ†ç‰‡æ–‡ä»¶ï¼ˆHLSæµä¸å®Œæ•´ï¼‰');
                    return;
                }

                // æ£€æŸ¥ç¼–ç æ˜¯å¦ä¸ºH.264ï¼ˆiOS9ä»…æ”¯æŒï¼‰
                if (!manifest.match(/#EXT-X-STREAM-INF:.*CODECS=".*avc1.*"/i)) {
                    callback(false, 'è§†é¢‘ç¼–ç éH.264ï¼ˆiOS9ä»…æ”¯æŒH.264ï¼‰');
                    return;
                }

                callback(true);
            };

            xhr.onerror = function() {
                callback(false, 'ç½‘ç»œé”™è¯¯ï¼ˆæ— æ³•ä¸‹è½½HLSæµï¼‰');
            };

            xhr.ontimeout = function() {
                callback(false, 'ä¸‹è½½è¶…æ—¶ï¼ˆ15ç§’æœªå®Œæˆï¼‰');
            };

            xhr.send();
        }

        function playStream(url) {
            player.src = url;
            player.load();

            player.onerror = function() {
                var errorCode = player.error ? player.error.code : 'æœªçŸ¥';
                var errorDetails = [
                    'MEDIA_ERR_ABORTED (1): æ’­æ”¾ä¸­æ–­',
                    'MEDIA_ERR_NETWORK (2): ç½‘ç»œé—®é¢˜',
                    'MEDIA_ERR_DECODE (3): è§£ç å¤±è´¥',
                    'MEDIA_ERR_SRC_NOT_SUPPORTED (4): æºä¸æ”¯æŒ'
                ].find(d => d.startsWith(`MEDIA_ERR_${errorCode}`)) || 'æœªçŸ¥é”™è¯¯';
                
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ æ’­æ”¾å¤±è´¥ï¼ˆé”™è¯¯ç ${errorCode}ï¼‰ï¼š${errorDetails}\næ’æŸ¥å»ºè®®ï¼š\n1. ç¡®è®¤æºåœ°å€æœ‰æ•ˆï¼ˆç”¨ç”µè„‘æµè§ˆå™¨ç›´æ¥è®¿é—®ï¼‰\n2. æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§\n3. è”ç³»æºæä¾›æ–¹ç¡®è®¤H.264ç¼–ç `;
            };

            player.play().then(function() {
                statusEl.className = 'status success';
                statusEl.textContent = 'âœ… æ’­æ”¾æˆåŠŸï¼å¦‚æœç”»é¢å¡é¡¿è¯·æ£€æŸ¥ç½‘ç»œ';
            }).catch(function(error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ æ’­æ”¾é”™è¯¯ï¼š${error.message}`;
            });
        }
    </script>
</body>
</html>
    